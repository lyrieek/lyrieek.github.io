<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>围棋打谱</title>
	<link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAAZdEVYdFNvZnR3YXJlAEFkb2JlIEltYWdlUmVhZHlxyWU8AAADImlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4wLWMwNjEgNjQuMTQwOTQ5LCAyMDEwLzEyLzA3LTEwOjU3OjAxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1LjEgV2luZG93cyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozNjc4NTQ2RkE3M0MxMUUxODBBMEVBM0E2NTk1RTg5NSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozNjc4NTQ3MEE3M0MxMUUxODBBMEVBM0E2NTk1RTg5NSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjM2Nzg1NDZEQTczQzExRTE4MEEwRUEzQTY1OTVFODk1IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjM2Nzg1NDZFQTczQzExRTE4MEEwRUEzQTY1OTVFODk1Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+PZ+7pgAABSFJREFUWEe9V21rHFUUPvO2Lw1FK4sloIlNY0xsdrcSaS1qhIYifimIYuKHFmkrUhRBf4Af/AMFUUStRRQkAf1gwQ9SKhgVLabQZGPs2qSxIRgSA9JA2c3Om+c5d2Z3OjtTatA+zdm999yX89xznznT1Wzb9s+/8xKtTJ8j3/fpTkDTNOosH6KR1z8hbWNjw//i1V4qPfU0ke8FU0IimvylIz4YPUB0LOJHU9Np5rtv6Pn35klbW1vzz76xh4rDh+iHr37iLGjNTICppvNGTAx+IJqlcNz3lC8+tm27RQaP6wEBj0m5vk5DB/dSZfIcHT71K5lYJOs5iOY59OSzB8hz1QLd0On7sxfpza+vSn+zYVM2Y9GpZ7roiYR5w4eH2KeyCN/0+V/o5XG1NsRHLw6AqcREbB1OEPddlzk45NkeuYF5Dp+ceTcajixGcCBtHr6jPkMLr7QFw0DGkFHVbxLwmBJfjbDyJeUwNYuz2QR8afPiPiO6MIDOPpezFCyJZIDNymTlTjVdV8aTDcMgyzJlMgBf2jyliZZPs7LBqhZ8Zq+Iqr62urrqf/naIJUeH6aLk7MUiXVLNBqc5kADGqdV56AeUhvxZTN6ogiLBwao8uMkPffuLEk4sHH5o8Oy6fj4gkwOBXd6dDedmGj3lUceiQjOoKlvK7RvpMw+9yZf+eBgxKezb5YF2MpASwPMnM/QJjgIKcnn2g45jivmOixK1hC+b+1joXMwxGojAOFANPzXRCikJB+yqgUmbex0Gz6+KYkVI6CKiWZl2gQHISX5wKFp7Ed6ddx31NinhBkYJjMDxAoLm4hw/JUiPfzYflqeW6BaXd3XVpAkODxyuAogJNE/1EtzP1+gsQ8qSoQY9z2XbtR9Gtw/IGoGTD7B71NVOvH5b9IPcXq0J1GsSVVvz75+coP98KTMXqhKrIBTRIRIC7ODUKKGVMaRJtY4UPXwBET3QwyJlUSg1QmM26hccaQKMwZZG9+P/YkEsImqYLgrZVAXKlccaWKNA2uxHzIBQzIRA7FCAiLCT48VaWBoLy0v/BmwU6NIf8bUabPekH6IfM5IFGubCHmvJGF2999Hc1OX6OiZQISI5/GziXl9xQeEBAAC87PX6OTEZemHgvtwrI96iz1qIcDHvFa50i7CF3oShYlY4dLgClQdEBH6LBZWaWiQVlxwDr+ObX7dNgJDO1GEqa9jZJnvg9HSADulSnFmJRlseHo0LmG4xxCh4JAlpBiGdpII04SpCAR9fKCDjSC6UIAwENK4ERecblk8VSkahnaSCNOEGX0KRIQfHylRX/kh+vuv6/I6xdtKBjkYqpdirHw4gbO5Ke3bQZIId3YXqHqpSsc/m4lUwiDA/b2dNxFYvroiviiB5cUV6t7dqVIHsG++8gc9WNqFJCqwb3G6mihC7IWYADIo+6D8IiDKJt7zYlJCcd8tH8YhoLgIzXyOGrZLdRYsrMGv6/TqmKCB8NFT7JQh9eLj77gvLsK4D/NSRYh/akmLgGzM99UmLma8NR9bigh9zmRIQET4/liJC8susuu2ZKA5KAfAx7/38Vmodv2G6kTQ0ZElc/s2ulJZpJPjM0KWwez5Xk1+3CwuNpnA0LYyW/OZbHfdezft2LmDCp33iKFtduQlliLMn/hpNvHWMVq/PAX+OMR/C46DywFkfwb6hf5HafTtM+rH6dLSEq2vr/N/HFXJ/b9hmiYVCgXq6uoi+Xleq9WoXq/L/d8J4HHP5XKUz+fpHzZkzzBe/el6AAAAAElFTkSuQmCC" type="image/x-icon">
	<script src="https://d3js.org/d3.v6.min.js" charset="utf-8"></script>
	<style>
	div {
		text-align: center;
	}

	svg {
		background: ivory
	}

	svg.editingMode {
		background: lightyellow
	}

	</style>
	<script>
	window.onload = function() {
		const width = 190 * 3;
		const height = 190 * 3;
		const padding = 25;
		let way = 19;
		let playerRole = 1; //1: black, 0:white
		let currentRole = 1;
		let isEditingMode = false;

		const svg = d3.select('#container')
			.append('svg')
			.attr('width', width + padding * 2 + 'px')
			.attr('height', height + padding * 2 + 'px');


		for (let y = 0; y < way; y++) {
			let gridLineXArray = [];
			let gridLineYArray = [];

			for (let x = 0; x < way; x++) {
				gridLineXArray.push([width / way * x + padding, width / way * y + padding])
				gridLineYArray.push([height / way * y + padding, height / way * x + padding])
			}

			svg.append("text")
				.attr("x", "0")
				.attr('y', height / way * (y + 1))
				.text(19 - y)

			svg.append("text")
				.attr("x", width / way * y + padding - 5)
				.attr('y', height + padding)
				.text(String.fromCharCode(65 + y))

			svg.append("path")
				.attr("class", "line")
				.attr('stroke', '#000')
				.attr("d", d3.line()(gridLineXArray));

			svg.append("path")
				.attr("class", "line")
				.attr('stroke', '#000')
				.attr("d", d3.line()(gridLineYArray));
		}

		//绘制星位 9路以上才绘制星位
		if (way > 9) {
			const star = [];
			star.push([3, 3]);
			star.push([way - 4, 3]);
			star.push([3, way - 4]);
			star.push([way - 4, way - 4]);
			//19路及以上才绘制全星位
			if (way >= 19) {
				const val = (way - way % 2) / 2;
				star.push([val, 3]);
				star.push([3, val]);
				star.push([val, val]);
				star.push([val, way - 4]);
				star.push([way - 4, val]);
			}
			for (const item of star) {
				svg.append("circle")
					// .attr('fill', '#000')
					.attr('r', '4')
					.attr("cx", width / way * item[0] + padding)
					.attr("cy", height / way * item[1] + padding);
			}
		}

		const calcChessPiecePoint = function(offset) {
			let compareNum = (offset - padding) % (width / way);
			if (compareNum > width / way / 2) {
				compareNum -= width / way;
			}
			return offset - compareNum;
		}

		const removeChessPieceHandler = (e) => {
			if (isEditingMode) {
				e.target.remove();
			}
		}

		const rendererChessPiece = function(chessPiece) {
			chessPieces.current = chessPiece;
			if (currentRole === 1) {
				chessPiece.attr('class', 'CP_black')
				chessPiece.attr('fill', '#000')
			} else {
				chessPiece.attr('class', 'CP_white')
				chessPiece.attr('fill', '#FFF')
			}
			if (!isEditingMode) {
				currentRole = Math.abs(currentRole - 1);
				return;
			}
			chessPiece.on('click', removeChessPieceHandler);
		}

		const chessPieces = Object.create(null);

		chessPieces.selecting = svg.append("circle")
			.attr('fill', '#777')
			.attr('r', 13)
			.attr('stroke', "black")
			.style('display', 'none')

		svg.on("mousemove", function(d, i) {
			if (currentRole === 1) {
				chessPieces.selecting.attr('fill', '#555')
			} else {
				chessPieces.selecting.attr('fill', '#CCC')
			}
			// (d.offsetX - padding) / (width / way)
			chessPieces.selecting.attr('cx', calcChessPiecePoint(d.offsetX));
			chessPieces.selecting.attr('cy', calcChessPiecePoint(d.offsetY));
			// chessPieces.selecting.attr('cx', d.offsetX);

			chessPieces.selecting.style('display', undefined);
		})
		chessPieces.selecting.on('click', () => rendererChessPiece(chessPieces.selecting.clone()))
		svg.on("mouseout", function(d, i) {
			if (d.offsetX < 0) {
				chessPieces.selecting.attr('display', 'none')
			}
		})

		d3.select('#editCP_btn').on('click', (e) => {
			isEditingMode = e.target.checked;
			if (isEditingMode) {
				svg.attr('class', 'editingMode')
				d3.select('#editingToolbar').style('display', 'inline');
				if (currentRole === 1) {
					d3.select('#switchBlackCP').attr('checked', 'checked');
				} else {
					d3.select('#switchWhiteCP').attr('checked', 'checked');
				}

				d3.selectAll('.CP_black,.CP_white').on('click', removeChessPieceHandler);
			} else {
				svg.attr('class', null)
				d3.select('#editingToolbar').style('display', 'none');
				d3.selectAll('.CP_black,.CP_white').on('click', null);
			}
		})
		d3.selectAll('[name="role"]').on('click', (e) => {
			currentRole = Number(e.target.value);
		})

	};

	</script>
</head>

<body>
	<div id="container"></div>
	<div id="toolbar">
		<input type="checkbox" name="edit" id="editCP_btn" />
		<label for="editCP_btn">编辑模式</label>
		<span id="editingToolbar" style="display: none;">
			<input type="radio" name="role" value=1 id="switchBlackCP" />
			<label for="switchBlackCP">黑棋</label>
			<input type="radio" name="role" value=0 id="switchWhiteCP" />
			<label for="switchWhiteCP">白棋</label>
		</span>
	</div>
</body>

</html>
